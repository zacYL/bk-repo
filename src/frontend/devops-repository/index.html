<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset=UTF-8>
        <meta name=viewport content="width=device-width,initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="icon" href="/ui/favicon.ico" type="image/x-icon" />
        <title>Devops制品库</title>
    </head>
<body>
    <div id="app"></div>
    <script>
        // standalone: 独立部署模式
        // ci: ci模式
        // saas: saas模式
        var MODE_CONFIG = '__BK_REPO_DEPLOY_MODE__' || 'standalone'
        var LOGIN_SERVICE_URL = '__BK_REPO_PAAS_LOGIN_URL__'
    </script>
    <script>
        const redirectUrl = location.href.split(/\?redirect=/)[1]

        window.getLoginUrl = function () {
            const cUrl = location.origin + (redirectUrl ? (redirectUrl + '?preview=true') : '')
            if (/\{+curl\}+/i.test(LOGIN_SERVICE_URL)) {
                return LOGIN_SERVICE_URL.replace(/\{+curl\}+/i, encodeURIComponent(cUrl))
            } else if (/=%s/.test(LOGIN_SERVICE_URL)) {
                return LOGIN_SERVICE_URL.replace(/%s/, cUrl)
            } else {
                const loginUrl = new URL(LOGIN_SERVICE_URL)
                if (/=$/.test(loginUrl.search)) {
                    return LOGIN_SERVICE_URL + cUrl
                    } else {
                    loginUrl.searchParams.append('c_url', cUrl)
                    return loginUrl.href
                }
            }
        }

        if (redirectUrl) {
            document.body.removeChild(document.querySelector('#app'))
            const xhr = new XMLHttpRequest()
            xhr.onreadystatechange = function (e) {
                const { readyState, status } = e.currentTarget
                if (readyState === 4 && status === 200) {
                    location.href = location.origin + redirectUrl + '?preview=true'
                } else if (status === 401) {
                    location.href = window.getLoginUrl()
                } else if (status === 403 || status === 404) {
                    printError(status)
                }
            }
            xhr.withCredentials = true
            xhr.open('HEAD', redirectUrl)
            xhr.send()
        }

        function printError (status) {
            let message
            switch (status) {
                case 403:
                    message = '未获得预览文件的访问权限'
                    break
                case 404:
                    message = '预览文件不存在'
                    break
                default:
                    message = '服务异常，请稍后重试'
            }
            document.writeln(
                '<div style="height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">'
                + '<img src="/ui/'
                + status
                + '.png" />'
                + '<p style="font-size: 20px; color: #979797; margin: 32px 0;">'
                + message
                + '</p>'
                + '</div>'
            )
        }
    </script>
</body>
